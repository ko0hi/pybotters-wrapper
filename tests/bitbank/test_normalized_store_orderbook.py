import pybotters
import pytest

import pybotters_wrapper as pbw


@pytest.fixture
def tester(orderbook_normalized_store_tester):
    store = pybotters.bitbankDataStore()
    store._onmessage(
        """42["message",{"room_name":"depth_whole_btc_jpy","message":{"data":{"asks":[["3760960","1.4278"],["3761016","0.0572"],["3761100","0.0001"],["3761358","0.002"],["3761359","0.0054"],["3761514","0.0098"],["3761755","0.0001"],["3761888","0.0357"],["3761890","0.02"],["3761999","0.5420"],["3762000","0.0405"],["3762007","0.02"],["3762020","0.0001"],["3762147","0.0058"],["3762289","0.0572"],["3762446","0.0500"],["3762901","1.4981"],["3763050","0.0054"],["3763848","0.0058"],["3764400","0.0001"],["3764498","0.0210"],["3764499","0.2002"],["3764949","0.04"],["3764999","0.2300"],["3765000","10.4719"],["3765089","0.04"],["3765294","0.8610"],["3767175","1.3330"],["3767271","0.0690"],["3767344","0.0100"],["3767445","0.0051"],["3768498","1.7180"],["3770000","0.9633"],["3770247","1.2000"],["3771605","1.7180"],["3772169","2.07"],["3772243","6.5300"],["3772805","1.2000"],["3773000","0.0636"],["3774000","0.0001"],["3774377","2.0800"],["3775907","0.0050"],["3776305","0.0029"],["3776844","0.0050"],["3777880","0.0029"],["3779000","0.0020"],["3779091","0.0100"],["3780000","0.8565"],["3780100","0.0090"],["3781234","0.0150"],["3782907","0.0020"],["3783000","0.0102"],["3783254","0.0005"],["3784975","0.0005"],["3785000","0.0010"],["3785300","0.0010"],["3786184","1.2000"],["3787591","0.0100"],["3788000","0.0001"],["3788359","0.0003"],["3789336","0.0013"],["3789723","0.0001"],["3790000","0.3423"],["3790566","0.0050"],["3790685","0.0116"],["3790907","0.0100"],["3791767","0.0050"],["3792002","0.0001"],["3794400","0.0100"],["3795000","0.1508"],["3795796","0.0100"],["3796562","0.0050"],["3796788","0.0080"],["3797000","0.0031"],["3798000","0.0500"],["3798440","0.0050"],["3798983","0.0001"],["3799000","0.0736"],["3799562","0.0030"],["3799893","0.0431"],["3799999","0.5615"],["3800000","7.1520"],["3800001","0.0100"],["3800481","0.0023"],["3800742","0.0029"],["3801000","0.0001"],["3801135","0.0050"],["3802332","0.0029"],["3803089","0.0934"],["3805000","0.0920"],["3809000","0.0001"],["3810000","1.0942"],["3813000","0.0001"],["3813017","0.0150"],["3813313","0.0205"],["3814000","0.0003"],["3814636","0.0100"],["3814721","0.0250"],["3814759","0.0065"],["3815000","0.3075"],["3818181","0.8727"],["3819998","0.1000"],["3820000","1.8565"],["3820614","0.0100"],["3821000","0.0001"],["3822222","0.0250"],["3823000","0.7502"],["3823051","0.0020"],["3823123","0.0200"],["3823153","0.0001"],["3823556","0.0001"],["3824995","0.0020"],["3824999","0.0250"],["3825000","0.0020"],["3827000","0.0189"],["3828000","0.2000"],["3828413","0.0160"],["3828450","0.1126"],["3828547","0.0024"],["3828715","0.0003"],["3828800","0.2000"],["3829000","0.0010"],["3830000","0.2009"],["3830600","0.0030"],["3833333","0.0350"],["3835000","0.1349"],["3836179","0.0284"],["3837211","0.0231"],["3837500","0.0530"],["3837868","0.0180"],["3838383","0.0040"],["3838712","0.1000"],["3838932","0.0028"],["3839369","0.3348"],["3840000","1.3719"],["3841234","0.1000"],["3842097","0.0029"],["3843702","0.0029"],["3844828","0.1000"],["3848300","0.0010"],["3848953","0.0001"],["3849873","0.0001"],["3850000","2.0304"],["3855600","0.0004"],["3856671","0.0044"],["3857485","0.0008"],["3858692","0.0300"],["3859138","0.0001"],["3859176","0.3683"],["3859201","0.0118"],["3860000","1.3607"],["3861960","0.0248"],["3862525","0.0161"],["3869365","0.0001"],["3869999","0.0250"],["3870000","0.0498"],["3870197","0.0009"],["3871000","0.0521"],["3872330","0.0015"],["3874893","0.0023"],["3875369","0.0001"],["3876000","0.0004"],["3876249","0.1127"],["3878000","0.0500"],["3880000","1.5135"],["3885246","0.0101"],["3888621","0.0023"],["3888876","0.8477"],["3889999","0.0100"],["3890000","2.5294"],["3890315","0.0014"],["3893066","0.0050"],["3894329","0.0023"],["3894400","0.0100"],["3895319","0.0050"],["3897000","0.0039"],["3897192","0.0012"],["3897979","0.1782"],["3898983","0.0001"],["3899700","0.1426"],["3899990","0.0020"],["3899999","0.9756"],["3900000","3.8052"],["3900104","0.0728"],["3900970","0.0433"],["3901000","0.0028"],["3901234","0.0100"],["3902111","0.1660"],["3908729","0.0001"],["3910000","0.1450"],["3911398","0.0142"],["3916428","0.0010"],["3917200","0.0010"],["3918000","0.0030"],["3918652","0.0050"],["3920000","0.4820"],["3924000","2.2030"],["3924172","0.0550"],["3925000","0.1720"],["3928940","0.0005"]],"bids":[["3760959","0.4039"],["3760465","0.0098"],["3760202","0.0100"],["3759590","0.0001"],["3759585","0.0178"],["3759582","0.0178"],["3758538","0.0054"],["3758510","0.0200"],["3758332","0.0200"],["3758236","0.021"],["3758235","1.799"],["3757957","0.0500"],["3757699","0.0054"],["3756918","0.0062"],["3756819","0.5420"],["3756184","0.9018"],["3755700","0.0400"],["3755393","0.8610"],["3755262","0.0400"],["3755000","0.0053"],["3754299","1.3330"],["3753000","0.2399"],["3752655","0.0665"],["3752003","0.0500"],["3752000","0.0414"],["3751834","0.0648"],["3751311","1.7180"],["3751295","0.0002"],["3751177","1.7180"],["3750857","0.0605"],["3750701","0.0003"],["3750628","0.0266"],["3750000","0.1103"],["3749892","1.2000"],["3749625","0.0007"],["3749150","0.0008"],["3749001","0.0039"],["3749000","0.0027"],["3746297","6.9400"],["3745145","0.0001"],["3745000","0.0104"],["3744960","0.0001"],["3744698","0.0012"],["3742955","0.0105"],["3742636","4.3820"],["3742154","0.0003"],["3741940","0.0001"],["3741500","0.0133"],["3741123","0.0270"],["3740003","0.1000"],["3740000","0.7224"],["3739500","0.0026"],["3739278","1.2000"],["3738225","0.0041"],["3738205","0.0041"],["3738015","2.7130"],["3738000","0.0162"],["3736007","0.0007"],["3735036","0.0250"],["3735000","0.6118"],["3734964","0.0008"],["3734858","0.0021"],["3732101","0.0329"],["3731597","0.0201"],["3731036","0.0250"],["3731000","0.0010"],["3730003","0.1000"],["3730000","0.1414"],["3729100","0.4578"],["3725036","0.0250"],["3725000","0.0500"],["3722727","0.0121"],["3722607","0.0014"],["3721215","1.7180"],["3720200","0.0245"],["3720003","0.1000"],["3720000","1.2741"],["3719036","0.0026"],["3719000","0.0002"],["3718167","0.0010"],["3718132","0.0015"],["3717549","0.0012"],["3717501","0.0250"],["3717450","0.0001"],["3717335","0.0071"],["3716742","0.0001"],["3715001","0.0001"],["3715000","0.0700"],["3714749","0.0001"],["3713817","0.0041"],["3713802","0.0041"],["3710025","0.0007"],["3710000","0.4528"],["3709746","0.0067"],["3709150","0.0050"],["3708339","0.0005"],["3708147","0.8610"],["3706948","0.0005"],["3706714","0.0008"],["3706276","0.0028"],["3704971","0.0001"],["3703333","0.0020"],["3703245","0.0001"],["3703118","0.0132"],["3702501","0.0250"],["3702000","0.0008"],["3701234","0.0170"],["3701115","0.0001"],["3700001","0.0007"],["3700000","1.5366"],["3696000","0.1621"],["3695036","0.4500"],["3692213","0.0122"],["3691036","0.0850"],["3690036","0.0250"],["3690001","0.1500"],["3690000","0.0602"],["3686000","0.0100"],["3685485","0.0003"],["3684001","0.1000"],["3682798","0.0001"],["3682426","0.0001"],["3680001","0.0800"],["3680000","0.2910"],["3675480","0.0001"],["3675000","0.0800"],["3674914","0.0093"],["3672512","0.0041"],["3672497","0.0041"],["3670000","0.3946"],["3669050","0.0200"],["3665814","0.0003"],["3665713","0.0067"],["3665458","0.0100"],["3665001","0.0001"],["3662195","0.0123"],["3661000","0.0100"],["3660003","0.1500"],["3660001","0.1500"],["3660000","0.1302"],["3659181","0.0003"],["3659000","0.0010"],["3657947","0.0023"],["3651115","0.0001"],["3650183","0.7571"],["3650000","4.0615"],["3648000","0.0067"],["3645000","0.0726"],["3644000","0.0100"],["3641468","0.0007"],["3640000","0.4477"],["3636000","0.0050"],["3635000","0.2000"],["3633735","0.1099"],["3632661","0.0124"],["3631634","0.0012"],["3630141","0.0020"],["3630000","0.4799"],["3629870","0.0989"],["3628268","0.0068"],["3622000","0.0010"],["3620000","0.3312"],["3616000","0.0001"],["3615001","0.0501"],["3612609","0.0007"],["3611000","0.0028"],["3610000","0.4109"],["3609989","0.0001"],["3603600","0.0125"],["3602000","0.0039"],["3601115","0.0001"],["3601000","0.0100"],["3600050","0.6760"],["3600001","0.0020"],["3600000","1.4520"],["3599999","0.0012"],["3599000","0.0002"],["3596723","0.0003"],["3590591","0.0210"],["3590519","0.0052"],["3590000","0.3424"],["3589668","0.0023"],["3586100","0.1392"],["3585900","0.0013"],["3582000","0.0560"],["3580100","0.0100"],["3580005","0.0050"],["3580000","1.6225"],["3579530","0.1000"],["3578889","0.0047"],["3577577","0.0100"],["3576000","0.0300"],["3575315","0.1500"],["3575000","0.0126"],["3574751","0.0278"],["3570788","0.0173"],["3570000","0.2432"],["3569416","0.0002"],["3568000","0.0001"],["3566175","0.0157"],["3565001","0.0001"],["3560256","0.0006"]],"timestamp":1687098841367,"sequenceId":"13470992879"}}}]""",
        None,
    )
    # best bid
    dummy_data = sorted(
        store.depth.find({"side": "buy"}), key=lambda x: x["price"], reverse=True
    )[0]
    return orderbook_normalized_store_tester(
        builder_factory_method=pbw.create_factory(
            "bitbank"
        ).create_normalized_store_builder,
        dummy_data=dummy_data,
        expected_item={
            "symbol": "btc_jpy",
            "side": "BUY",
            "price": 3760959.0,
            "size": 0.4039,
        },
    )


def test_insert(tester):
    tester.test_insert()


def test_update(tester):
    tester.test_update()


def test_delete(tester):
    tester.test_delete()


def test_item(tester):
    tester.test_item()
